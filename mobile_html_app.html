<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Animal Sound Detector</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide-react/0.263.1/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* iOS-specific optimizations */
        html, body {
            height: 100%;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            -webkit-text-size-adjust: none;
        }
        
        /* Prevent zoom on input focus */
        input, select, textarea {
            font-size: 16px !important;
        }
        
        /* Better touch targets */
        button {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* PWA styles */
        .app-container {
            max-width: 100vw;
            min-height: 100vh;
            background: #1f2937;
        }
        
        /* iOS safe area support */
        @supports (padding: max(0px)) {
            .app-container {
                padding-top: max(20px, env(safe-area-inset-top));
                padding-bottom: max(20px, env(safe-area-inset-bottom));
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
            }
        }
    </style>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkFuaW1hbCBTb3VuZCBEZXRlY3RvciIsCiAgInNob3J0X25hbWUiOiAiU291bmREZXRlY3RvciIsCiAgImRlc2NyaXB0aW9uIjogIkRldGVjdCBlbGVwaGFudCBhbmQgYmlyZCBzb3VuZHMiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzFmMjkzNyIsCiAgInRoZW1lX2NvbG9yIjogIiM3YzNhZWQiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTV0TXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXlOREVpSUdobGFXZG9kRDBpTWpReElpQjJhV1YzUW05NFBTSXdJREFnTWpReElpQXlOREVpUGp4eVpXTjBJSGRwWkhSb1BTSXlOREVpSUdobGFXZG9kRDBpTWpReElpQm1hV3hzUFNJak1XWXlPVE0zSWk4K1BIUmxlSFFnZUQwaU1UQXdJaUI1UFNJeE1qQWlJR1pwYkd3OUlpTjNhR2wwWlNJZ1ptOXVkQzF6YVhwbFBTSXpNaUlnWm05dWRDMTNaV2xuYUhROUltSnZiR1FpUGxkaGRtVnpQQzkwWlhoMFBqeDBaWGgwSUhnOUlqRXdNQ0lnZVQwaU1UWXdJaUJtYVd4c1BTSWpkMmhwZEdVaUlHWnZiblF0YzJsNlpUMGlNVGdpUGtGdWFXMWhiQ0JUYjNWdVpEd3ZkR1Y0ZEQ0OEwzTjJaejQ9IiwKICAgICAgInNpemVzIjogIjI0MXgyNDEiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    
    <!-- iOS-specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sound Detector">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNDEiIGhlaWdodD0iMjQxIiB2aWV3Qm94PSIwIDAgMjQxIDI0MSI+PHJlY3Qgd2lkdGg9IjI0MSIgaGVpZ2h0PSIyNDEiIGZpbGw9IiMxZjI5MzciLz48dGV4dCB4PSIxMDAiIHk9IjEyMCIgZmlsbD0iI3doaXRlIiBmb250LXNpemU9IjMyIiBmb250LXdlaWdodD0iYm9sZCI+V2F2ZXM8L3RleHQ+PHRleHQgeD0iMTAwIiB5PSIxNjAiIGZpbGw9IiN3aGl0ZSIgZm9udC1zaXplPSIxOCI+QW5pbWFsIFNvdW5kPC90ZXh0Pjwvc3ZnPg==">
</head>
<body>
    <div id="root" class="app-container"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { Volume2, Play, Pause, Settings, Info, Activity, Waves } = LucideReact;

        const AnimalSoundDetector = () => {
            const [isListening, setIsListening] = useState(false);
            const [detectionLevel, setDetectionLevel] = useState(0);
            const [detectedSignals, setDetectedSignals] = useState([]);
            const [sensitivity, setSensitivity] = useState(75);
            const [lowerFreqLimit, setLowerFreqLimit] = useState(5);
            const [upperFreqLimit, setUpperFreqLimit] = useState(25);
            const [showSettings, setShowSettings] = useState(false);
            const [audioContext, setAudioContext] = useState(null);
            const [analyzer, setAnalyzer] = useState(null);
            const [frequencyData, setFrequencyData] = useState([]);
            const animationRef = useRef();

            // Animal sound detection data
            const animalSounds = [
                { name: "Contact Call", frequency: "14-24 Hz", description: "Long-distance communication", animal: "Elephant" },
                { name: "Greeting Rumble", frequency: "12-18 Hz", description: "Social bonding", animal: "Elephant" },
                { name: "Robin Song", frequency: "2000-8000 Hz", description: "Territorial and mating call", animal: "Bird" },
                { name: "Cardinal Whistle", frequency: "1500-6000 Hz", description: "Clear whistling notes", animal: "Bird" },
                { name: "Crow Caw", frequency: "300-2000 Hz", description: "Deep harsh calls", animal: "Bird" },
                { name: "Owl Hoot", frequency: "200-1200 Hz", description: "Low-pitched territorial call", animal: "Bird" },
                { name: "Dog Bark", frequency: "150-2000 Hz", description: "Alert or territorial", animal: "Mammal" },
                { name: "Cat Purr", frequency: "20-50 Hz", description: "Contentment vocalization", animal: "Mammal" }
            ];

            useEffect(() => {
                return () => {
                    if (animationRef.current) {
                        cancelAnimationFrame(animationRef.current);
                    }
                    if (audioContext && audioContext.state !== 'closed') {
                        audioContext.close();
                    }
                };
            }, [audioContext]);

            const startListening = async () => {
                try {
                    // iOS requires user gesture to start audio context
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            sampleRate: 48000,
                            channelCount: 1,
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        } 
                    });
                    
                    const context = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // iOS Safari requires resuming context
                    if (context.state === 'suspended') {
                        await context.resume();
                    }
                    
                    const source = context.createMediaStreamSource(stream);
                    const analyzerNode = context.createAnalyser();
                    
                    analyzerNode.fftSize = 4096; // Reduced for mobile performance
                    analyzerNode.smoothingTimeConstant = 0.8;
                    
                    source.connect(analyzerNode);
                    
                    setAudioContext(context);
                    setAnalyzer(analyzerNode);
                    setIsListening(true);
                    
                    analyzeAudio(analyzerNode);
                    
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    alert('Unable to access microphone. Please check permissions and try again.');
                }
            };

            const stopListening = () => {
                if (audioContext && audioContext.state !== 'closed') {
                    audioContext.close();
                }
                if (animationRef.current) {
                    cancelAnimationFrame(animationRef.current);
                }
                setIsListening(false);
                setDetectionLevel(0);
                setFrequencyData([]);
                setAudioContext(null);
                setAnalyzer(null);
            };

            const analyzeAudio = (analyzerNode) => {
                const bufferLength = analyzerNode.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                const analyze = () => {
                    if (!analyzerNode) return;
                    
                    analyzerNode.getByteFrequencyData(dataArray);
                    
                    // Create frequency chart data (optimized for mobile)
                    const chartData = [];
                    const sampleRate = 48000;
                    const maxFreq = Math.min(5000, upperFreqLimit * 2);
                    const stepSize = Math.max(2, Math.floor(bufferLength / 100)); // Fewer points for mobile
                    
                    for (let i = 1; i < bufferLength && i * sampleRate / 2 / bufferLength <= maxFreq; i += stepSize) {
                        const frequency = (i * sampleRate / 2) / bufferLength;
                        const amplitude = dataArray[i];
                        chartData.push({
                            frequency: Math.round(frequency),
                            amplitude: amplitude,
                            normalized: (amplitude / 255) * 100
                        });
                    }
                    
                    setFrequencyData(chartData);
                    
                    // Detection analysis
                    const lowerBin = Math.floor(lowerFreqLimit * bufferLength / (sampleRate / 2));
                    const upperBin = Math.floor(upperFreqLimit * bufferLength / (sampleRate / 2));
                    let totalEnergy = 0;
                    let peakFreq = 0;
                    let maxAmplitude = 0;
                    
                    for (let i = Math.max(1, lowerBin); i < Math.min(bufferLength, upperBin); i++) {
                        const amplitude = dataArray[i];
                        totalEnergy += amplitude;
                        
                        if (amplitude > maxAmplitude) {
                            maxAmplitude = amplitude;
                            peakFreq = (i * sampleRate / 2) / bufferLength;
                        }
                    }
                    
                    const binCount = Math.max(1, upperBin - lowerBin);
                    const avgEnergy = totalEnergy / binCount;
                    const normalizedLevel = Math.min(100, (avgEnergy / 255) * 100 * (sensitivity / 50));
                    
                    setDetectionLevel(normalizedLevel);
                    
                    // Simulate detection
                    if (normalizedLevel > 40 && Math.random() > 0.99) {
                        const matchingSounds = animalSounds.filter(sound => {
                            const freqRange = sound.frequency.match(/(\d+)-(\d+)/);
                            if (freqRange) {
                                const soundLow = parseInt(freqRange[1]);
                                const soundHigh = parseInt(freqRange[2]);
                                return (soundLow <= upperFreqLimit && soundHigh >= lowerFreqLimit);
                            }
                            return false;
                        });
                        
                        if (matchingSounds.length > 0) {
                            const detectedSound = matchingSounds[Math.floor(Math.random() * matchingSounds.length)];
                            const newDetection = {
                                id: Date.now(),
                                timestamp: new Date().toLocaleTimeString(),
                                type: detectedSound.name,
                                animal: detectedSound.animal,
                                frequency: `${Math.round(peakFreq)}Hz`,
                                confidence: Math.round(70 + Math.random() * 25),
                                amplitude: Math.round(normalizedLevel),
                                description: detectedSound.description
                            };
                            
                            setDetectedSignals(prev => [newDetection, ...prev.slice(0, 4)]); // Limit for mobile
                        }
                    }
                    
                    animationRef.current = requestAnimationFrame(analyze);
                };
                
                analyze();
            };

            const FrequencyChart = () => {
                if (!frequencyData.length) return null;

                const maxAmplitude = Math.max(...frequencyData.map(d => d.amplitude), 1);
                const chartHeight = 100; // Smaller for mobile
                const chartWidth = 280;
                
                const pathPoints = frequencyData.map((point, index) => {
                    const x = (index / (frequencyData.length - 1)) * chartWidth;
                    const y = chartHeight - (point.amplitude / maxAmplitude) * chartHeight;
                    return `${index === 0 ? 'M' : 'L'} ${x} ${y}`;
                }).join(' ');

                return (
                    <div className="bg-gray-900 rounded-lg p-3">
                        <div className="flex justify-between items-center mb-2">
                            <h4 className="text-sm font-medium text-white">Live Spectrum</h4>
                            <div className="text-xs text-gray-400">
                                {frequencyData.length > 0 && `${frequencyData[0]?.frequency}Hz - ${frequencyData[frequencyData.length - 1]?.frequency}Hz`}
                            </div>
                        </div>
                        
                        <svg width={chartWidth} height={chartHeight} className="w-full h-auto border border-gray-700 rounded bg-black">
                            <path d={pathPoints} fill="none" stroke="rgb(34, 197, 94)" strokeWidth="2"/>
                            <path d={`${pathPoints} L ${chartWidth} ${chartHeight} L 0 ${chartHeight} Z`} fill="rgba(34, 197, 94, 0.2)"/>
                        </svg>
                        
                        <div className="flex justify-between text-xs text-gray-400 mt-1">
                            <span>Low</span>
                            <span className="text-blue-400">{lowerFreqLimit}-{upperFreqLimit}Hz</span>
                            <span>High</span>
                        </div>
                    </div>
                );
            };

            return (
                <div className="max-w-md mx-auto bg-gray-800 text-white min-h-screen">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-purple-600 to-blue-600 p-4">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <Waves size={24} />
                                <h1 className="text-xl font-bold">Animal Sound Detector</h1>
                            </div>
                            <button
                                onClick={() => setShowSettings(!showSettings)}
                                className="p-2 rounded-full bg-white/20 hover:bg-white/30"
                            >
                                <Settings size={20} />
                            </button>
                        </div>
                        
                        <p className="text-sm opacity-90 mt-1">
                            Detecting {lowerFreqLimit}-{upperFreqLimit} Hz frequency range
                        </p>
                    </div>

                    {/* Settings Panel */}
                    {showSettings && (
                        <div className="bg-gray-700 p-4 border-b border-gray-600">
                            <h3 className="font-semibold mb-4">Detection Settings</h3>
                            
                            {/* Sensitivity */}
                            <div className="mb-4">
                                <label className="text-sm text-gray-300 block mb-1">
                                    Sensitivity: {sensitivity}%
                                </label>
                                <input
                                    type="range"
                                    min="25"
                                    max="100"
                                    value={sensitivity}
                                    onChange={(e) => setSensitivity(parseInt(e.target.value))}
                                    className="w-full"
                                />
                            </div>

                            {/* Frequency Range */}
                            <div className="mb-4">
                                <div className="mb-3">
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-xs text-gray-400">Lower: {lowerFreqLimit} Hz</span>
                                        <span className="text-xs text-gray-400">Upper: {upperFreqLimit} Hz</span>
                                    </div>
                                    <input
                                        type="range"
                                        min="1"
                                        max="50"
                                        value={lowerFreqLimit}
                                        onChange={(e) => setLowerFreqLimit(parseInt(e.target.value))}
                                        className="w-full mb-2"
                                    />
                                    <input
                                        type="range"
                                        min="51"
                                        max="5000"
                                        value={upperFreqLimit}
                                        onChange={(e) => setUpperFreqLimit(parseInt(e.target.value))}
                                        className="w-full"
                                    />
                                </div>

                                {/* Preset Buttons */}
                                <div className="grid grid-cols-2 gap-2">
                                    <button
                                        onClick={() => { setLowerFreqLimit(5); setUpperFreqLimit(25); }}
                                        className="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-sm"
                                    >
                                        Elephants<br/><span className="text-xs opacity-75">5-25 Hz</span>
                                    </button>
                                    <button
                                        onClick={() => { setLowerFreqLimit(1500); setUpperFreqLimit(8000); }}
                                        className="bg-green-600 hover:bg-green-700 px-3 py-2 rounded text-sm"
                                    >
                                        Birds<br/><span className="text-xs opacity-75">1.5-8 kHz</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main Detection Area */}
                    <div className="p-4">
                        <div className="text-center mb-6">
                            <div className="mb-4">
                                {isListening ? (
                                    <button
                                        onClick={stopListening}
                                        className="bg-red-500 hover:bg-red-600 text-white p-6 rounded-full shadow-lg"
                                    >
                                        <Pause size={32} />
                                    </button>
                                ) : (
                                    <button
                                        onClick={startListening}
                                        className="bg-green-500 hover:bg-green-600 text-white p-6 rounded-full shadow-lg"
                                    >
                                        <Play size={32} />
                                    </button>
                                )}
                            </div>
                            
                            <p className="text-lg font-medium">
                                {isListening ? 'Listening for animal sounds...' : 'Tap to start listening'}
                            </p>
                            
                            {isListening && (
                                <div className="mt-2 text-sm text-gray-400">
                                    Detection Level: {Math.round(detectionLevel)}%
                                </div>
                            )}
                        </div>

                        {/* Live Frequency Chart */}
                        {isListening && (
                            <div className="mb-6">
                                <FrequencyChart />
                            </div>
                        )}

                        {/* Detection Level */}
                        {isListening && (
                            <div className="mb-6">
                                <div className="bg-gray-900 rounded-lg p-3">
                                    <div className="flex justify-between text-xs text-gray-400 mb-1">
                                        <span>Detection Level</span>
                                        <span>{Math.round(detectionLevel)}%</span>
                                    </div>
                                    <div className="w-full bg-gray-700 rounded-full h-2">
                                        <div 
                                            className={`h-2 rounded-full transition-all duration-200 ${
                                                detectionLevel > 70 ? 'bg-red-500' : 
                                                detectionLevel > 40 ? 'bg-yellow-500' : 'bg-green-500'
                                            }`}
                                            style={{ width: `${Math.min(100, detectionLevel)}%` }}
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Detection Status */}
                        <div className="bg-gray-700 rounded-lg p-4 mb-4">
                            <div className="flex items-center space-x-2 mb-2">
                                <Activity size={20} className={isListening ? 'text-green-400' : 'text-gray-500'} />
                                <span className="font-medium">Status</span>
                            </div>
                            <p className="text-sm text-gray-300">
                                {isListening 
                                    ? `Monitoring ${detectedSignals.length} detected signals`
                                    : 'Ready to detect animal sounds across frequency spectrum'
                                }
                            </p>
                        </div>

                        {/* Recent Detections */}
                        <div className="bg-gray-700 rounded-lg p-4">
                            <h3 className="font-semibold mb-3 flex items-center">
                                <Volume2 size={20} className="mr-2" />
                                Recent Detections
                            </h3>
                            
                            {detectedSignals.length === 0 ? (
                                <p className="text-gray-400 text-sm">No animal sounds detected yet...</p>
                            ) : (
                                <div className="space-y-2 max-h-48 overflow-y-auto">
                                    {detectedSignals.map((signal) => (
                                        <div key={signal.id} className="bg-gray-600 rounded p-3">
                                            <div className="flex justify-between items-start mb-1">
                                                <div>
                                                    <span className="font-medium text-sm">{signal.type}</span>
                                                    <span className="ml-2 px-2 py-1 bg-gray-500 rounded-full text-xs">
                                                        {signal.animal}
                                                    </span>
                                                </div>
                                                <span className="text-xs text-gray-300">{signal.timestamp}</span>
                                            </div>
                                            <div className="text-xs text-gray-300 mb-1">{signal.description}</div>
                                            <div className="flex justify-between text-xs text-gray-300">
                                                <span>Freq: {signal.frequency}</span>
                                                <span>Confidence: {signal.confidence}%</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Info Panel */}
                        <div className="mt-4 bg-blue-900/50 rounded-lg p-4">
                            <div className="flex items-center space-x-2 mb-2">
                                <Info size={20} className="text-blue-400" />
                                <span className="font-medium text-blue-400">Animal Sound Detection</span>
                            </div>
                            <p className="text-sm text-gray-300 leading-relaxed">
                                This app can detect sounds across a wide frequency spectrum - from infrasonic 
                                elephant calls (5-25 Hz) to high-pitched bird songs (1.5-8 kHz). Use the 
                                frequency controls to focus on specific animal communications.
                            </p>
                        </div>

                        {/* Installation Instructions */}
                        <div className="mt-4 bg-green-900/30 rounded-lg p-4">
                            <div className="flex items-center space-x-2 mb-2">
                                <div className="w-5 h-5 bg-green-500 rounded flex items-center justify-center">
                                    <span className="text-white text-xs">+</span>
                                </div>
                                <span className="font-medium text-green-400">Install as App</span>
                            </div>
                            <p className="text-sm text-gray-300 leading-relaxed">
                                On iPhone: Tap the Share button and select "Add to Home Screen" to install this as a native app.
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // Register service worker for PWA functionality
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,Y29uc3QgQ0FDSEVfTkFNRSA9ICdhbmltYWwtc291bmQtZGV0ZWN0b3ItdjEnOwpjb25zdCB1cmxzVG9DYWNoZSA9IFsKICAnLycKXTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignaW5zdGFsbCcsIGV2ZW50ID0+IHsKICBldmVudC53YWl0VW50aWwoCiAgICBjYWNoZXMub3BlbihDQUNIRV9OQU1FKQogICAgICAudGhlbihjYWNoZSA9PiBjYWNoZS5hZGRBbGwodXJsc1RvQ2FjaGUpKQogICk7Cn0pOwoKc2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGV2ZW50ID0+IHsKICBldmVudC5yZXNwb25kV2l0aCgKICAgIGNhY2hlcy5tYXRjaChldmVudC5yZXF1ZXN0KQogICAgICAudGhlbihyZXNwb25zZSA9PiByZXNwb25zZSB8fCBmZXRjaChldmVudC5yZXF1ZXN0KSkKICApOwp9KTs=');
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(AnimalSoundDetector));
    </script>
</body>
</html>